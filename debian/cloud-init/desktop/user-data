#cloud-config
---
write_files:
- path: "/etc/systemd/network/50-wlp2s0.network"
  content: |
    [Match]
    Name=wlp2s0

    [Network]
    DHCP=yes
    LinkLocalAddressing=no

    [DHCP]
    RouteMetric=2048
- path: "/etc/systemd/network/50-enp.network"
  content: |
    [Match]
    Name=enp*

    [Network]
    DHCP=yes
    LinkLocalAddressing=no
- path: "/etc/systemd/system/chef-client.service"
  content: |
    [Unit]
    Description=Chef Client daemon
    After=network.target auditd.service
    RequiresMountsFor=/data/secret

    [Service]
    Type=oneshot
    ExecStart=/usr/bin/chef-client -o recipe[system_update::debian]
    ExecReload=/bin/kill -HUP $MAINPID
    SuccessExitStatus=3
- path: "/etc/systemd/system/chef-client.timer"
  content: |
    [Unit]
    Description=chef-client periodic run

    [Install]
    WantedBy=timers.target

    [Timer]
    OnStartupSec=1min
    OnUnitActiveSec=60min
- path: "/etc/wpa_supplicant/wpa_supplicant-wlp2s0.conf"
  content: |
    update_config=1
    ap_scan=1
    fast_reauth=1
    network={
    	ssid="WIFI_SSID"
    	psk=WIFI_PSK
    }
password: password
chpasswd:
  expire: false
ssh_pwauth: false
package_upgrade: true
apt_upgrade: true
manage_etc_hosts: localhost
fqdn: desktop.lan
runcmd:
- systemctl enable chef-client.timer
- systemctl start chef-client.timer
- grub-install
