#cloud-config
---
write_files:
- path: "/etc/systemd/network/50-eno1.network"
  content: |
    [Match]
    Name=eno1

    [Network]
    LinkLocalAddressing=no
    DHCP=no
    DNS=192.168.62.230
    DNS=8.8.8.8

    [Address]
    Address=192.168.62.251/23

    [Route]
    Gateway=192.168.62.240
- path: "/etc/systemd/network/50-eno2.network"
  content: |
    [Match]
    Name=eno2

    [Network]
    LinkLocalAddressing=no
    DHCP=no
- path: "/etc/systemd/network/50-ens1.network"
  content: |
    [Match]
    Name=ens1

    [Network]
    DHCP=no
    LinkLocalAddressing=no

    [Address]
    Address=169.254.127.251/16
- path: "/etc/systemd/system/chef-client.service"
  content: |
    [Unit]
    Description=Chef Client daemon
    After=network.target auditd.service
    RequiresMountsFor=/data/secret

    [Service]
    Type=oneshot
    ExecStart=/usr/bin/chef-client -c /data/secret/chef/client.rb -o recipe[system_update::debian],recipe[kubelet-app::master],recipe[gluster-pod]
    ExecReload=/bin/kill -HUP $MAINPID
    SuccessExitStatus=3
- path: "/etc/systemd/system/chef-client.timer"
  content: |
    [Unit]
    Description=chef-client periodic run

    [Install]
    WantedBy=timers.target

    [Timer]
    OnStartupSec=1min
    OnUnitActiveSec=10min
password: password
chpasswd:
  expire: false
ssh_pwauth: false
package_upgrade: true
apt_upgrade: true
manage_etc_hosts: true
fqdn: vm1.lan
runcmd:
- systemctl enable chef-client.timer
- systemctl start chef-client.timer
- grub-install
